!DOCTYPE html>
<html style="height: 100%; margin: 0; padding: 0;">
<head>
    <title>BOT 1t5</title>
    <link rel="stylesheet" href="s.css">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #cv {
            width: 100%;
            height: 100%;
        }
        #sequencer-iframe {
            position: fixed; /* Changed from absolute to fixed to ensure it covers the whole page */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
            opacity: 0; /* Invisible but still clickable */
            z-index: 2; /* Ensure it's above the canvas */
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }
    </style>
</head>
<body>
<canvas id="cv"></canvas>
<iframe id="sequencer-iframe" src="EmbeddedSequencer/smallIndex.html"></iframe>

<script src="g2.js"></script>
<script src="c2.js"></script>
<script src="d2.js"></script>
<script>
    let cci2 = 18; // Initial CCI2 value
    const initialCCI2 = 21; // Store the initial value of cci2 to reset later
    let seed = 9; // Seed value, can be adjusted for production purposes

    // Enhanced randomization function using a seed
    function randomWithSeed(seedValue) {
        const x = Math.sin(seedValue) * 10000;
        return x - Math.floor(x);
    }

    // Function to calculate cci2 based on channelIndex and seed, now with enhanced randomness
    function calculateCCI2(channelIndex) {
        const randomSeed = seed + channelIndex; // Combine seed with channelIndex for unique seed per channel
        const randomMultiplier = randomWithSeed(randomSeed) * 100; // Generate a pseudo-random number [0, 100)
        return Math.floor(randomMultiplier) + 1; // Ensure CCI2 is within 1-100 range
    }

    const channelPlaybackListener = new BroadcastChannel('channel_playback');
    channelPlaybackListener.onmessage = (event) => {
        if (event.data.action === 'stop') {
            cci2 = initialCCI2; // Reset to initial cci2 value when stop is received
            console.log(`Stop received. CCI2 reset to initial value ${initialCCI2}`);
        } else {
            const { channelIndex } = event.data;
            cci2 = calculateCCI2(channelIndex); // Update the CCI2 with enhanced randomization
            console.log(`Received channel playback: Channel ${channelIndex}. CCI2 updated to ${cci2} based on seed ${seed}.`);
        }
    };

    document.addEventListener('click', () => {
    // Construct the message
    const message = JSON.stringify({ command: 'play' });
    
    // Notify parent window, which should relay to the sequencer iframe
    window.parent.postMessage(message, '*'); // Again, replace '*' with the parent's origin in production
});

</script>
