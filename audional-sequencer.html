<!DOCTYPE html>
<html>
<head>
    <style>
        :root {
    --main-bg-color: #000;
    --secondary-bg-color: #333;
    --primary-color: #fff;
    --accent-color: #f00;
    --play-button-dimension: 50px;
    --stop-button-dimension: 50px;
    --control-button-dimension: 20px;
    --box-shadow-style: 0 0 10px var(--main-bg-color) inset;
    --margin-style: 10px;
    --default-font: Arial, sans-serif;
    --step-button-dimension: 20px; /* added */
    --sequence-light-dimension: 20px; /* added */
}

body {
    background-color: var(--main-bg-color);
    color: var(--primary-color);
    font: normal normal normal 100%/1 var(--default-font);
}

#drum-machine {
    width: 100%;
    margin: 0 auto;
    padding: 0px;
    background-color: var(--secondary-bg-color);
    border: 5px solid var(--main-bg-color);
}

h1 {
    text-align: center;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: relative;
}

.button {
    border: none;
    background-color: var(--primary-color);
    cursor: pointer;
    box-shadow: var(--box-shadow-style);
}

h1 .button {
    padding: 10px;
    color: var(--main-bg-color);
    font-size: 1em;
}
h3 .subtext {
    font-size: 0.8em; /* Customize the font size for shrinking the subtext */
    opacity: 0.7; /* Customize the opacity for shrinking the subtext */
}

h3:hover .subtext {
    font-size: 1em; /* Customize the font size for the shrunk subtext on hover */
    opacity: 0.5; /* Customize the opacity for the shrunk subtext on hover */
}

.step-button {
    margin-top: 0px;
    position: relative;
    width: 15px;
    flex: 1 1 auto; /* added */
    height: 20px;
    background-color: #555;
    color: #fff;
}



.control-button {
    width: var(--control-button-dimension);
    height: var(--control-button-dimension);
}
.play-button {
    position: relative;
    top: 0px; /* Adjust the value as needed */
    width: var(--play-button-dimension);
    height: var(--play-button-dimension);
}
#play.selected {
    background-color: #00ff00;
}
.button-label {
    color: #00ff00; /* Green */
}



.stop-button {
    position: relative;
    top: 0px; /* Adjust the value as needed */
    width: var(--stop-button-dimension);
    height: var(--stop-button-dimension);
}
.button-label.stop {
    color: #ff0000; /* Red */
}


#stop.selected ~ #play {
    background-color: var(--primary-color);
}

.stop-button:active,
.stop-button.selected {
    background-color: var(--accent-color);
}


.channel {
    display: flex;
}

.steps-container {
    flex-wrap: wrap;
    gap: 0px;
    margin: 0px 0;
}


.button-container {
  display: flex;
  align-items: center;
}
.title {
  font-size: 40px; /* Adjust the font size as needed */
}

.small-text {
  font-size: 20px; /* Set the smaller font size for Beta and eta */
}

#play {
    animation: flash 2s infinite ease-in-out;
}

#play.selected, 
#stop.selected ~ #play {
    animation: none; /* Stop the animation when the button is selected */
}

#stop.selected ~ #play {
    background-color: var(--primary-color);
}

.step-button:active,
.step-button.selected
{
    background-color: var(--accent-color);
}

.step-button.playing {
    box-shadow: 0 0 10px rgb(150, 150, 150) inset;
}

.step-button.playing.selected {
    box-shadow: 0 0 10px rgb(150, 1, 1) inset;
}


.clear-button {
    background-color: #ff0;
}

.mute-button {
  background-color: #800;
}
.mute-button.selected {
  background-color: rgb(255, 0, 0);
}

.load-sample-button {
  flex: 1;
  overflow: auto;
  text-overflow: ellipsis;
  font-size: 0.5em;
  height: 20px;  /* set the height of the buttons */
  padding: 5px;  /* adjust padding as necessary */
}

.load-sample-button:hover::after {
  position: absolute;
  top: 100%; /* Position it below the load-sample-button */
  left: 0;
  background: var(--primary-color);
  color: var(--main-bg-color);
  z-index: 1;
}


.step-button:nth-child(16n+1) {
    background-color: #ffff00; /* yellow */
}

.step-button:nth-child(4n+1):not(:nth-child(16n+1)) {
    background-color: #add8e6; /* light blue */
}

.channel-container .step-button.selected {
    background-color: #ff0000; /* red */
}

@keyframes flash {
    0% {background-color: var(--primary-color);}
    50% {background-color: #00ff00;}
    100% {background-color: var(--primary-color);}
}


.channel-controls {
    margin-top: 10px; /* Add a top margin if needed */
}
.button-label {
    position: center;
    z-index: 2;
}
.centered {
    display: block;
    text-align: center;
}
.larger-text {
    font-size: 1.5em;
}

.smaller-text {
    font-size: 1em;
}
.bright-orange {
    color: #f7931a;
}
.subtext-container {
    display: flex;
    justify-content: flex-end;
    margin-right: 400px;
}

.centered-text {
    text-align: right;
}
.new-button-container {
    position: absolute;
    bottom: 20px;
    right: 20px;
    text-align: right;
}

.new-button {
    padding: 10px 20px;
    color: black;
    background-color: white;
    border: none;
    border-radius: 5px;
    font-size: 0.75em;
    font-weight: bold;
    box-shadow: var(--box-shadow-style);
    cursor: pointer;
    margin-left: auto;

}

.new-button-subtext {
    display: block;
    font-size: 1em;
    color: var(--primary-color);
    opacity: 0.7;
}
.mode-switcher {
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 50px;
}

.mode-switcher label {
  margin-right: 10px;
}

.mode-switcher input[type="checkbox"] {
  appearance: none;
  width: 40px;
  height: 20px;
  background-color: #ccc;
  border-radius: 10px;
  position: relative;
  outline: none;
  cursor: pointer;
}

.mode-switcher input[type="checkbox"]:checked {
  background-color: #2196f3;
}

.mode-switcher input[type="checkbox"]::before {
  content: "";
  position: absolute;
  top: 1px;
  left: 1px;
  width: 18px;
  height: 18px;
  background-color: #fff;
  border-radius: 50%;
  transition: transform 0.2s ease;
}

.mode-switcher input[type="checkbox"]:checked::before {
  transform: translateX(20px);
}

#steps-container, #sequence-lights {
  display: flex;
  flex-direction: row;
  justify-content: space-between;
  width: 90%;
  margin-left: 10%; /* Add 20% indentation from the left margin */

}
.sequence-light, .step-button {
  grid-column: span 1;
  width: var(--step-button-dimension); /* Update to use the same variable as step buttons */

}
.sequence-light {
  width: var(--step-button-dimension); /* Update to use the same variable as step buttons */
  height: 15px;
  background-color: grey; /* Add your off state styles here */
  box-sizing: border-box;
}

.sequence-light.on {
  background-color: greenyellow; /* Add your off state styles here */
 /* Add your on state styles here */
}

.tooltip {
  position: relative;
  display: inline-block;
  cursor: pointer;
}

.tooltip .tooltiptext {
  visibility: hidden;
  width: 200px; /* Adjust the width as needed */
  background-color: #333; /* Set the background color */
  color: #fff; /* Set the text color */
  text-align: center;
  border-radius: 8px; /* Adjust the border radius as needed */
  padding: 10px;
  position: absolute;
  z-index: 1;
  bottom: -20%; /* Position the tooltip above the text */
  left: 50%;
  transform: translateX(20%); /* Center the tooltip horizontally */
  opacity: 0;
  transition: opacity 0.3s;
}

.tooltip:hover .tooltiptext {
  visibility: visible;
  opacity: 1;
}



</style>    
</head>
<body>
    <div id="drum-machine">
        <h1>
          <span class="button-label">Play</span>
          <div class="button button-round tooltip">
            <div class="button play-button" id="play"></div>
            <span class="tooltiptext">Start the sequence.</span>
          </div>
          <span class="title">Audional Sequencer <span class="bright-orange">&#x20bf;</span>itcoin<span class="bright-orange">&#x20bf;</span>eats<span class="small-text">   &#x20bf;eta</span></span>
          <span class="button-label stop">Stop</span>
          <div class="button button-round tooltip">
            <div class="button stop-button" id="stop"></div>
            <span class="tooltiptext">Stop the sequence.</span>
          </div>
          <div class="bpm-container">
            BPM: <input type="range" min="60" max="180" value="105" step="1" id="bpm-slider">
            <div class="bpm-display" id="bpm-display">105</div>
          </div>
        </h1>
        <div class="subtext-container">
          <p class="subtext centered-text">
            Raw On-chain <span class="bright-orange">&#x20bf;</span>itcoin Audionals: playing live, directly from the <span class="">&#x20bf;</span>lockchain!
          </p>
        </div>
        <main id="app" role="main">

        <div class="channel" id="channel-1">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                    <div class="channel-controls">
                        <div class="button-container">
                           
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="channel" id="channel-2">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                 <div class="channel-controls">
                        <div class="button-container">
                            
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="channel" id="channel-3">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                    <div class="channel-controls">
                        <div class="button-container">
                            
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div class="channel" id="channel-4">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                    <div class="channel-controls">
                        <div class="button-container">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="channel" id="channel-5">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                    <div class="channel-controls">
                        <div class="button-container">
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="channel" id="channel-6">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                    <div class="channel-controls">
                        <div class="button-container">
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="channel" id="channel-7">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                    <div class="channel-controls">
                        <div class="button-container">
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="channel" id="channel-8">
            <button class="load-sample-button" title="Load New Audional">Load New Audional
                <span class="tooltiptext">Use this button to load a new audional sample into the current channel.</span>

            </button>
            <div>
                <button class="control-button clear-button tooltip">
                  C
                  <span class="tooltiptext">Clear the current channel's sequence.</span>
                </button>
                <button class="control-button mute-button tooltip">
                  M
                  <span class="tooltiptext">Mute or unmute the current channel.</span>
                </button>
              </div>
            <div class="channel-container">
                <div class="steps-container"></div>
                <div class="controls-container">
                    <div class="channel-controls">
                        <div class="button-container">
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    <div class="button-container">
      <button id="save-button" class="tooltip">Save
        <span class="tooltiptext">This button will save your sequence into JSON file for download so you can recall it later on.</span>
      </button>
      <input type="file" id="save-file-input" style="display: none">
      <button id="load-button" class="tooltip">Load
        <span class="tooltiptext">This button will load your audional composition JSON files, even while the sequencer is playing live.</span>
      </button>
      <input type="file" id="load-file-input" style="display: none" accept=".json">
      <button class="new-button">Inscribe Audional Composition</button>
      <span class="new-button-subtext">(Coming soon...)</span>
    </div>
  </div>

    <script>

    let isPlaying = false;
    let currentStep = 0;
    let totalStepCount = 0
    let beatCount = 1; // individual steps
    let barCount = 1; // bars
    let sequenceCount = 1; // sequences
    let timeoutId;
    let isPaused = false; // a flag to indicate if the sequencer is paused
    let pauseTime = 0;  // tracks the total paused time
    let stopClickCount = 0;
    let playButton = document.getElementById('play');
    let stopButton = document.getElementById('stop');
    let saveButton = document.getElementById('save-button');
    let loadButton = document.getElementById('load-button');
    let bpm = 105;
    let audioContext;
    let currentStepTime;
    let startTime;
    let nextStepTime;
    let stepDuration;
    let gainNodes = [];
    let isMuted = false;
    let channelMutes = []; // Declare the channelMutes array as a global variable
    let muteState = false
    


    const sequenceLength = 64;
    const audioBuffers = new Map();


    function displayUpdatedValues() {
      console.log("isPlaying:", isPlaying);
      console.log("currentStep:", currentStep);
      console.log("totalStepCount:", totalStepCount);
      console.log("beatCount:", beatCount);
      console.log("barCount:", barCount);
      console.log("sequenceCount:", sequenceCount);
      console.log("stopClickCount:", stopClickCount);
      console.log("channels:", channels);
      console.log("bpm:", bpm);
      console.log("audioContext:", audioContext);
      console.log("currentStepTime:", currentStepTime);
      console.log("startTime:", startTime);
      console.log("nextStepTime:", nextStepTime);
      console.log("stepDuration:", stepDuration);
      console.log("gainNodes:", gainNodes)
       // Log the mute state of each channel
      channels.forEach((channel, index) => {
        const isMuted = channel.dataset.muted === 'true';
        console.log(`Channel-${index + 1} - Muted: ${isMuted}`);
      });
    }


  function getIDFromURL(url) {
    const parts = url.split('/');
    return parts[parts.length - 1];
  }

  function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
  }
  

  const fetchAudio = async (url, channelIndex, loadSampleButtonElement) => {
    try {
      const response = await fetch(url);
      const data = await response.json();
      const audioData = base64ToArrayBuffer(data.audioData.split(',')[1]);
      
      if (!audioContext) {
        try {
            window.AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
        } catch (e) {
            console.warn('Web Audio API is not supported in this browser');
        }
    }

      const audioBuffer = await decodeAudioData(audioData); // We'll define this function later
      audioBuffers.set(url, audioBuffer); // Store the audio buffer in the Map

      const channel = document.querySelector(`.channel[data-id="Channel-${channelIndex + 1}"]`);
      channel.dataset.originalUrl = url; // Store the original URL
      channel.dataset.audioDataLoaded = 'true';

      if (loadSampleButtonElement) {
        const filename = data.filename || data.fileName; // Check both properties
        loadSampleButtonElement.classList.add('button-fixed-width');
        loadSampleButtonElement.style.width = '200px'; // or whatever width you want
        loadSampleButtonElement.textContent = filename ? filename.substring(0,20) : 'Load New Audional';
        loadSampleButtonElement.title = filename ? filename : 'Load New Audional';
      } else {
        console.log("Button element not found.");
      }
    } catch (error) {
      console.error('Error fetching audio:', error);
    }
  };

  const decodeAudioData = (audioData) => {
    return new Promise((resolve, reject) => {
      audioContext.decodeAudioData(audioData, resolve, reject);
    });
  };




  function exportSettings() {
    let settings = { channels: [], bpm: bpm };
    channels.forEach((channel, index) => {
        let triggers = [];
        let toggleMuteSteps = [];
        let stepButtons = channel.querySelectorAll('.step-button');
        stepButtons.forEach((button, i) => {
            if (button.classList.contains('selected')) {
                triggers.push(i + 1); // we use (i+1) because nth-child selector is 1-based
            }
            if (button.classList.contains('toggle-mute')) {
                toggleMuteSteps.push(i + 1);
            }
        });

        let mute = channel.dataset.muted === 'true';
        let url = channel.dataset.originalUrl; // Use the original URL
        settings.channels.push({ triggers: triggers, mute: mute, toggleMuteSteps: toggleMuteSteps, url: url });
    });

        let filename = `audiSeq_BPM${bpm}.json`;
        return { settings: JSON.stringify(settings, null, 2), filename: filename };
    }


// Update the mute state in a single function
function updateMuteState(channel, shouldMute) {
  const channelIndex = parseInt(channel.dataset.id.split('-')[1]) - 1;
  channel.dataset.muted = shouldMute ? 'true' : 'false';
  const muteButton = channel.querySelector('.mute-button');

  muteButton.classList.toggle('selected', shouldMute);
  channelMutes[channelIndex] = shouldMute;

  console.log(`Channel-${channel.dataset.id.replace("Channel-", "")} Muted: ${shouldMute}`);
}


function importSettings(json) {
  let settings = JSON.parse(json);
  bpm = settings.bpm;

  // Get the bpm slider and display elements
  let bpmSlider = document.getElementById('bpm-slider');
  let bpmDisplay = document.getElementById('bpm-display');

  // Update the bpm slider and display
  bpmSlider.value = bpm;
  bpmDisplay.innerText = bpm;  // update the bpm text label

  // Manually trigger the input event to update the sequencer's bpm
  bpmSlider.dispatchEvent(new Event('input'));

  if (settings.currentSequence !== undefined) {
    currentSequence = settings.currentSequence; // Set current sequence from imported data
  }

  settings.channels.forEach((chSettings, index) => {
    let channel = document.querySelector(`.channel[data-id="Channel-${index + 1}"]`);
    let loadSampleButton = channel.querySelector('.load-sample-button');

    // Fetch and set audio sample URL only if url is defined
    if(chSettings.url) {
      fetchAudio(chSettings.url, index, loadSampleButton);
    }

    // Set mute settings
    updateMuteState(channel, chSettings.mute);
    console.log('Mute has been toggled in importSettings 1st call');


    // Set trigger buttons
    let stepButtons = channel.querySelectorAll('.step-button');
    stepButtons.forEach(button => {
      button.classList.remove('selected', 'toggle-mute'); // clear existing triggers and mute toggles
    });
    chSettings.triggers.forEach(i => stepButtons[i - 1].classList.add('selected')); // set new triggers

    if (chSettings.toggleMuteSteps) {
      chSettings.toggleMuteSteps.forEach(i => {
        const shouldMute = !stepButtons[i - 1].classList.contains('toggle-mute');
        stepButtons[i - 1].classList.toggle('toggle-mute'); // toggle mute
        updateMuteState(channel, shouldMute);
        console.log('Mute has been toggled in importSettings 2nd call');

      });
    }
  });
}



document.addEventListener("DOMContentLoaded", function() {
  let saveFileInput = document.getElementById('save-file-input');
  let loadFileInput = document.getElementById('load-file-input');

  saveButton.addEventListener('click', () => {
    let { settings, filename } = exportSettings();

    // Create a Blob with the settings
    let blob = new Blob([settings], { type: 'application/json' });

    // Create a download link for the Blob
    let url = URL.createObjectURL(blob);
    let downloadLink = document.createElement('a');
    downloadLink.href = url;
    downloadLink.download = filename;

    // Trigger a click on the download link
    downloadLink.click();
  });

  loadButton.addEventListener('click', () => {
    // Trigger a click on the load file input
    loadFileInput.click();
  });

  loadFileInput.addEventListener('change', () => {
    let file = loadFileInput.files[0];
    let reader = new FileReader();
    reader.onload = function(e) {
      let settings = e.target.result;
      importSettings(settings);
    };
    reader.readAsText(file);
  });
});

let channels = document.querySelectorAll('.channel');

channels.forEach((channel, index) => {
  channel.dataset.id = `Channel-${index + 1}`;

  const muteButton = channel.querySelector('.mute-button');
  muteButton.addEventListener('click', () => {
    const currentMuteState = channel.dataset.muted === 'true';
    updateMuteState(channel, !currentMuteState);
    console.log(`Channel-${index + 1} channels.forEach just toggled updateMuteState`);
  });

  const clearButton = channel.querySelector('.clear-button');
  clearButton.addEventListener('click', () => {
    const stepButtons = channel.querySelectorAll('.step-button');
    stepButtons.forEach(button => {
      button.classList.remove('selected');
    });
  });

  const stepsContainer = channel.querySelector('.steps-container');
  stepsContainer.innerHTML = '';

  // Check if the current channel is 'channel-1'
  let isChannelOne = channel.id === 'channel-1';

  const fragment = document.createDocumentFragment();
  for (let i = 0; i < 64; i++) {
    const button = document.createElement('button');
    button.classList.add('step-button');
    button.addEventListener('click', () => {
      button.classList.toggle('selected');
    });

    fragment.appendChild(button);
  }

  stepsContainer.appendChild(fragment);


    const audionalIDs = [
            { id: '6d962189218b836cf33e2dc1adbc981e90242aa395f0868178773065f76f144ei0', label: 'Audional Sample #1, 125BPM' },
            { id: '0b8eff3f39f4095d0f129bb8dd75f29159f8725c7e66046bf41f70ebb9f60d93i0', label: 'Melophonic Bass + Kick, 125BPM' },
            { id: '6c01b1214fc4d4016d683380d066849e6bc645276b102604c098bd35fd77f791i0', label: 'Melophonic Snare' },
            { id: '6d8be8186e63b4557e51edd66184a567bc6f5f9f5ba4bb34ba8c67e652c1934ei0', label: 'Neill Armstrong "One small step for man..."' },
            { id: '3364803cb3032ce95f4138a214c15a9b36dcb70f574a477f27615d448e1cdeb8i0', label: '8 Bit Drum Loop, 105BPM' },
            { id: '43efcebb84113c6df56bf5b8a455685c043492de9f5635d4108c4211c1f6841fi0', label: 'Pump It' },
            { id: 'fef956676f3cbd6019a03d75c1a4a295c25b33653644b8f6ebde387971f9a677i0', label: 'Wobble Bass, 125BPM' },
            { id: 'c41587924f9d93d01cb71ca925fd664d6e50f1ac8e3c975d5e1e1f1bb0ff11b3i0', label: 'Audional Jim' },
            { id: 'a511d79317efac68fea3b14070bebe208aefde07ce1c55d6f4cfe42e8273cbdbi0', label: 'Denim Avengers Kick' },
            { id: '5b2dc7be28ad70c233b06d0ba23888aa38eb8711c24f8462d2774ac5fb7e7212i0', label: 'Denim Avengers Kick' },
            { id: 'a511d79317efac68fea3b14070bebe208aefde07ce1c55d6f4cfe42e8273cbdbi0', label: 'Denim Avengers Tom' },
            { id: 'fb0e5e0b512ad0caf2b0ebed011d2d29aa670ce48f3c147cfc9e633d963f369bi0', label: 'Denim Avengers cheese HUUH' },
            { id: '4d73f49620b708e098a59b9c7d5a40bd0c14057d4b803e2f8842d183708ed8a5i0', label: 'Denim Avengers I Like Cheese' },
            { id: '752bd66406185690c6f14311060785170df91a887b42740e1dde27e5fbf351cbi0', label: 'Denim Avengers MS10 woop' },
            { id: '8fa54ad2d9e297c79b225eff67a481ebc8682dacf4fe9dbf5b692a60b237c163i0', label: 'Entertainment - Quiet Loop' },
            { id: 'c6decce29948ea64df9a24e689340c5907b6da207d74d13973fc5ca4dd3bd80ai0', label: 'Bitcoin Step Melody G, 105BPM' },
            { id: 'e9885c35376ae95dd291bb02075b0763fb3e655d51dc981984130b8366a6d3c8i0', label: 'Bitcoin Step Mel Fill 2, 105BPM' },
            { id: '34e73ef718034a3c0fdeba53899a2af8ee7771f252c419ab63cd13b0a39f6b10i0', label: 'Bitcoin Step Mel Fill 1, 105BPM' },
            { id: '435c5c22eaf0c1791e09cb46d56ce942eb312372376abf5b5420200b1424ff7fi0', label: 'Bitcoin Step Melody E, 105BPM' },
            { id: 'ccf99852fb85d63b5f65124fe506b08c11eb400a7b1da75cd3e0c9538fc49977i0', label: 'Bitcoin Step Drums Beat, 105BPM' },
            { id: 'ef8fdd599beee731e06aba4a9ed02d9c7bfe62147b27f6b6deaf22c8c067ab11i0', label: 'Bitcoin Step Melody A, 105BPM' },
            { id: '187a8c18ebfe07c18aea0e86cd99b3100474c1c53f56f02ee096723f1a35ce70i0', label: 'Bitcoin Step Drums Crash, 105BPM' },
            { id: '2b6b23199eae0760ee26650a0cc02c49b94fc8fd1f519a95417f0f8478246610i0', label: 'Bitcoin Step Melody M, 105BPM' },
            { id: '474f2b0aab9020757826b168ce58725871fd2abb26c6ca805de4b07e314416d1i0', label: 'Bitcoin Step Outro Fill 1, 105BPM' },
            { id: '1aa69c9d3b451ab3b584dba57ba6d6fedc6e9cb3df6830b9da270e84e51ea72di0', label: 'Bitcoin Step Melody L, 105BPM' },
            { id: '81f9e6afc38b8c647d4ea258c29f13b81f6c1a2d40afd9c0a385d03126b4d11di0', label: 'Bitcoin Step Melody F, 105BPM' },
            { id: '4c40da69e783cfa96d2900bd15622c1ea60ad31e8ce9459cec13d155f39c463fi0', label: 'Bitcoin Step Intro Fill 1, 105BPM' },
            { id: '695368ae1092c0633ef959dc795ddb90691648e43f560240d96da0e2753a0a08i0', label: 'Bitcoin Step Melody O, 105BPM' },
            { id: 'd4ce1d1e80e90378d8fc49fd7e0e24e7f2310b2f5eb95d0c2318c47b6c9cd645i0', label: 'Bitcoin Step Melody K, 105BPM' },
            { id: 'e4cb3caff3b4a5192adf0f2ab5cd9da378bacfbafce56c3d4fb678a313607970i0', label: 'Bitcoin Step Melody I, 105BPM' },
            { id: '898cba6dc32faab5be09f13092b7500b13eb22f1e7b3d604c8e6e47b0becd139i0', label: 'Bitcoin Step Melody C, 105BPM' },
            { id: 'ed13d5389ae6273839342698b6d5bd3342c51eb472f32b8306e60f8e1e903ce8i0', label: 'Bitcoin Step Mel Fill 3, 105BPM' },
            { id: 'b0fb7f9eb0fe6c368a8d140b1117234431da0cd8725e9f78e6573bb7f0f61dadi0', label: 'Bitcoin Step Melody N, 105BPM' },
            { id: '0e38f29c76b29e471f5f0022a5e98f9ae64b5b1d8f25673f85e02851daf22526i0', label: 'Bitcoin Step Mel Fill 4, 105BPM' },
            { id: '244c785d6df173f8425d654cfc6d2b006c7bb47a605c7de576ed87022e42c7dfi0', label: 'Bitcoin Step Melody D, 105BPM' },
            { id: 'a72adee5a07200a623c40831ae5979bc7562b542788c3ded35d9e81e39c6014fi0', label: 'Bitcoin Step Melody B, 105BPM' },
            { id: '6a84401579707b76d9b9a77cc461e767f7ea8f08cc0e46dee0d21e5023cdde33i0', label: 'Bitcoin Step Melody J, 105BPM' },
            { id: '83174080310b0ab71c7a725461f3bd9e486bb62727b73134ee2c67f191d9d586i0', label: 'Bitcoin Step Mel Fill 5, 105BPM' },
            { id: '4f9bed6449d99ef3cbb0fabefac6890c20ef17db2bfe7c07f1386cb43277f220i0', label: 'Bitcoin Step Melody H, 105BPM' }
            ];

            const loadSampleButton = channel.querySelector('.load-sample-button');
                loadSampleButton.addEventListener('click', () => {
                    // Create a basic modal for audional ID input
                    const idModal = document.createElement('div');
                    idModal.style.position = 'fixed';
                    idModal.style.left = '0';
                    idModal.style.top = '0';
                    idModal.style.width = '100%';
                    idModal.style.height = '100%';
                    idModal.style.backgroundColor = 'rgba(0,0,0,0.5)';
                    idModal.style.display = 'flex';
                    idModal.style.justifyContent = 'center';
                    idModal.style.alignItems = 'center';
                    idModal.style.zIndex = '9999';

                    const idModalContent = document.createElement('div');
                    idModalContent.style.backgroundColor = 'white';
                    idModalContent.style.padding = '20px';
                    idModalContent.style.borderRadius = '10px';
                    idModalContent.style.maxHeight = '500px';  // Adjust this value as per your needs
                    idModalContent.style.overflowY = 'auto';

                    const instructionText = document.createElement('p');
                    instructionText.textContent = 'Enter the ordinal ID for the Audional you want to load:';
                    idModalContent.appendChild(instructionText);

                    // Add input field
                    const audionalInput = document.createElement('input');
                    audionalInput.type = 'text';
                    audionalInput.placeholder = 'Enter ID or choose below:';
                    audionalInput.style.marginBottom = '10px';
                    idModalContent.appendChild(audionalInput);

                    const loadButton = document.createElement('button');
                    loadButton.textContent = 'Load';
                    loadButton.addEventListener('click', () => {
                        const audionalUrl = 'https://ordinals.com/content/' + getIDFromURL(audionalInput.value);
                        fetchAudio(audionalUrl, index, loadSampleButton);
                        document.body.removeChild(idModal);
                    });
                    idModalContent.appendChild(loadButton);

                    audionalIDs.forEach((audionalObj) => {
                        const idLink = document.createElement('a');
                        idLink.href = '#';
                        idLink.textContent = audionalObj.label;
                        idLink.style.display = 'block';
                        idLink.style.marginBottom = '10px';
                        idLink.addEventListener('click', (e) => {
                            e.preventDefault();
                            const audionalUrl = 'https://ordinals.com/content/' + getIDFromURL(audionalObj.id);
                            fetchAudio(audionalUrl, index, loadSampleButton);
                            document.body.removeChild(idModal);
                        });
                        idModalContent.appendChild(idLink);
                    });

                    idModal.appendChild(idModalContent);
                    document.body.appendChild(idModal);
                });

        });

        if (playButton && stopButton) {
          const channel1 = document.querySelector('#channel-0 .step-button:nth-child(4n+1)');
          if (channel1) channel1.classList.add('selected');

          const channel2Beat1 = document.querySelector('#channel-1 .step-button:nth-child(1)');
          if (channel2Beat1) channel2Beat1.classList.add('selected');

          const channel2Beat6 = document.querySelector('#channel-1 .step-button:nth-child(6)');
          if (channel2Beat6) channel2Beat6.classList.add('selected');

          let isPaused = false;  // Add this line to declare the isPaused flag

          playButton.addEventListener('click', () => {
            if (!isPlaying) {
              startScheduler();
              playButton.classList.add('selected');
              stopButton.classList.remove('selected');
              isPlaying = true;
              isPaused = false;  // Ensure that the isPaused flag is set to false when starting playback
            } else if (!isPaused) {  // If the sequencer is playing and is not paused, pause the sequencer
              pauseScheduler();
              isPaused = true;
            } else {  // If the sequencer is paused, resume the sequencer
              resumeScheduler();
              isPaused = false;
            }
          });

          stopButton.addEventListener('click', () => {
              if (isPlaying) {
                  stopScheduler();
                  stopButton.classList.add('selected');
                  playButton.classList.remove('selected');
                  isPlaying = false;
                  isPaused = false;  // Reset the isPaused flag when stopping the sequencer
                  beatCount = 0;  // reset the beat count
                  barCount = 0; // reset the bar count
                  sequenceCount = 0; // reset the sequence count
                  currentStep = 0;  // reset the step count
                  totalStepCount = 0;
                  resetStepLights();  // reset the step lights
              }
          });

        } else {
          console.error("Play or Stop button is not defined");
        }


  const bpmSlider = document.getElementById('bpm-slider');
  const bpmDisplay = document.getElementById('bpm-display');
  bpmSlider.addEventListener('input', () => {
    bpm = bpmSlider.value;
    bpmDisplay.textContent = bpm;
  });

  
  const presets = {
  preset1: {
  "channels": [
    {
      "triggers": [
        1,
        6,
        9,
        14,
        17,
        22,
        25,
        30,
        33,
        38,
        41,
        46,
        49,
        54,
        57,
        62,
        63
      ],
      "mute": true,
      "toggleMuteSteps": [128, 493, 511],
      "url": "https://ordinals.com/content/0b8eff3f39f4095d0f129bb8dd75f29159f8725c7e66046bf41f70ebb9f60d93i0"
    },
    {
      "triggers": [
        1,
        17,
        33,
        49
      ],
      "mute": true,
      "toggleMuteSteps": [384, 493, 511],
      "url": "https://ordinals.com/content/ccf99852fb85d63b5f65124fe506b08c11eb400a7b1da75cd3e0c9538fc49977i0"
    },
    {
      "triggers": [
        61,
        62
      ],
      "mute": false,
      "toggleMuteSteps": [493, 511],
      "url": "https://ordinals.com/content/752bd66406185690c6f14311060785170df91a887b42740e1dde27e5fbf351cbi0"
    },
    {
      "triggers": [
        4,
        20,
        36,
        52,
        60
      ],
      "mute": true,
      "toggleMuteSteps": [256, 493, 511],
      "url": "https://ordinals.com/content/5b2dc7be28ad70c233b06d0ba23888aa38eb8711c24f8462d2774ac5fb7e7212i0"
    },
    {
      "triggers": [
        3,
        19,
        35,
        47
      ],
      "mute": false,
      "toggleMuteSteps": [493, 511],
      "url": "https://ordinals.com/content/3364803cb3032ce95f4138a214c15a9b36dcb70f574a477f27615d448e1cdeb8i0"
    },
    {
      "triggers": [
        1,
        16,
        33,
        48,
        50
      ],
      "mute": true,
      "toggleMuteSteps": [256, 493, 511],
      "url": "https://ordinals.com/content/fb0e5e0b512ad0caf2b0ebed011d2d29aa670ce48f3c147cfc9e633d963f369bi0"
    },
    {
      "triggers": [
        61
      ],
      "mute": true,
      "toggleMuteSteps": [379],
      "url": "https://ordinals.com/content/4d73f49620b708e098a59b9c7d5a40bd0c14057d4b803e2f8842d183708ed8a5i0"
    },
    {
      "triggers": [
        3,
        7,
        11,
        15,
        19,
        23,
        27,
        31,
        35,
        39,
        43,
        47,
        51,
        55,
        59,
        63,
        64
      ],
      "mute": true,
      "toggleMuteSteps": [511],
      "url": "https://ordinals.com/content/6c01b1214fc4d4016d683380d066849e6bc645276b102604c098bd35fd77f791i0"
    }
          ],
          "bpm": "105"
        },
};

// Add this function to handle manual toggle of the mute button
function toggleMute(channelElement) {
  const channelIndex = parseInt(channelElement.dataset.id.split('-')[1]) - 1;
  const isMuted = channelMutes[channelIndex];
  updateMuteState(channelElement, !isMuted, channelIndex);
  console.log('Mute has been toggled by the toggleMute function');

}

// The loadPreset function is updated to use updateMuteState function
  const loadPreset = (preset) => {
  const presetData = presets[preset];

  if (!presetData) {
    console.error('Preset not found:', preset);
    return;
  }

  presetData.channels.forEach((channelData, index) => {
    const { url, triggers, toggleMuteSteps, mute } = channelData;

    if (url) { // Only fetch audio if a URL is provided
      const loadSampleButton = document.querySelector(`.channel[data-id="Channel-${index + 1}"] .load-sample-button`);
      fetchAudio(url, index, loadSampleButton);
    }

    triggers.forEach(pos => {
      const btn = document.querySelector(`.channel[data-id="Channel-${index + 1}"] .step-button:nth-child(${pos})`);
      if (btn) btn.classList.add('selected');
    });

    toggleMuteSteps.forEach(pos => {
      const btn = document.querySelector(`.channel[data-id="Channel-${index + 1}"] .step-button:nth-child(${pos})`);
      if (btn) btn.classList.add('toggle-mute');
      console.log(`Channel-${index + 1} loadPreset classList.add`);
    });

    const channelElement = document.querySelector(`.channel[data-id="Channel-${index + 1}"]`);
    const muteButton = channelElement.querySelector('.mute-button');
    if (muteButton) {
      updateMuteState(channelElement, mute); // Correctly pass the 'mute' argument to updateMuteState function
      console.log(`Channel-${index + 1} updateMuteState toggled by the loadPreset function - Muted: ${mute}`);
    }
  });
};


// Load a preset when the page loads
const presetToLoadOnPageLoad = 'preset1';
if (presets[presetToLoadOnPageLoad]) {
  loadPreset(presetToLoadOnPageLoad);
} else {
  console.error('Preset not found:', presetToLoadOnPageLoad);
}


    
  function setChannelVolume(channelIndex, volume) {
    const channel = document.querySelector(`.channel[data-id="Channel-${channelIndex + 1}"]`);
    channel.dataset.volume = volume;
    updateChannelVolume(channel);
    }

  function updateChannelVolume(channel) {
    const volume = parseFloat(channel.dataset.volume);
    const gainNode = gainNodes[parseInt(channel.dataset.id.split('-')[1]) - 1];
    gainNode.gain.value = volume;
    }

  function createGainNodes() {
    const audioContext = new AudioContext();
    channels.forEach(channel => {
        const gainNode = audioContext.createGain();
        gainNode.gain.value = 1; // Initial volume set to 1 (full volume)
        gainNode.connect(audioContext.destination);
        gainNodes.push(gainNode);
    });
    }

    function startScheduler() {
        audioContext = new AudioContext();
        startTime = audioContext.currentTime;
        nextStepTime = startTime;

        scheduleNextStep();
    }

    function pauseScheduler() {
        clearTimeout(timeoutId); // Clear the current timeout without closing the audio context
        pauseTime = audioContext.currentTime;  // record the time at which the sequencer was paused
        isPaused = true;
    }

    function resumeScheduler() {
      if(isPaused) {
          // Replace the startTime adjustment with a nextStepTime reset
          nextStepTime = audioContext.currentTime;
          isPaused = false;
      }
      scheduleNextStep(); // Begin scheduling steps again
  }


    function scheduleNextStep() {
        stepDuration = 60 / bpm / 4;

        timeoutId = setTimeout(() => {
            playStep();
            scheduleNextStep();
        }, (nextStepTime - audioContext.currentTime) * 1000);
    }

    function renderPlayhead(buttons, currentStep, isMuted) {
      buttons.forEach((button, buttonIndex) => {
      button.classList.remove('playing');
      button.classList.remove('triggered');

      if (buttonIndex === currentStep && !isMuted) {
        button.classList.add('playing');
      }

      if (button.classList.contains('selected')) {
        button.classList.add('triggered');
      }
    });
  }

  function handleStep(channel, channelData, totalStepCount) {
    let isMuted = channel.dataset.muted === 'true';
    const isToggleMuteStep = channelData.toggleMuteSteps.includes(totalStepCount);

    // Update toggleMuteState only if conditions are met
    if (isToggleMuteStep) {
      isMuted = !isMuted;
      channel.dataset.muted = isMuted ? 'true' : 'false';
      // Update the mute state in the DOM
      updateMuteState(channel, isMuted);
      console.log('Mute toggled by the handleStep function');
    }

    return isMuted;
  }




function playSound(channel, currentStep, isMuted) {
  if (channel.querySelectorAll('.step-button')[currentStep].classList.contains('selected') && !isMuted) {
    const url = channel.dataset.originalUrl;
    const audioBuffer = audioBuffers.get(url);
    if (audioBuffer) {
      const source = audioContext.createBufferSource();
      source.buffer = audioBuffer;
      source.connect(audioContext.destination);
      source.start();
    }
  }
}

function playStep() {
  const presetData = presets.preset1;

  channels.forEach((channel, index) => {
    const buttons = channel.querySelectorAll('.step-button');
    const channelData = presetData.channels[index];

    if (!channelData) {
      console.error('Channel data not found for index:', index);
      return;
    }

    renderPlayhead(buttons, currentStep, channel.dataset.muted === 'true');
    const isMuted = handleStep(channel, channelData, totalStepCount);
    playSound(channel, currentStep, isMuted);
  });

    // Log the beat, bar, and sequence counts
    //console.log('Step:', currentStep);
    //console.log('Beat:', beatCount);
    //console.log('Bar:', barCount);  // Use barCount instead of currentBar
    //console.log('Sequence:', sequenceCount);

    currentStep = (currentStep + 1) % 64;
    totalStepCount = (totalStepCount + 1);

    if (currentStep % 4 === 0) {
        beatCount++;  // No wrap-around here
    }

    if (currentStep % 16 === 0) {
        barCount = (barCount + 1);
    }

    if (currentStep % 64 === 0) {
        sequenceCount++;
    }

    nextStepTime += stepDuration;

    displayUpdatedValues();

}

  function stopScheduler() {
      if (audioContext) {
          audioContext.close();
      }
      clearTimeout(timeoutId);

      // Reset counters
      currentStep = 0;
      beatCount = 1;
      barCount = 1; // Reset barCount to 1
      sequenceCount = 0;
      isPaused = false;
      pauseTime = 0;
  }

  function resetStepLights() {
    const buttons = document.querySelectorAll('.step-button');
    buttons.forEach(button => {
        button.classList.remove('playing');
    });
    }

  function togglePlayState(isPlaying, startStopFunction, firstButton, secondButton) {
    if (!isPlaying) {
      isPlaying = true;
      startStopFunction();
      firstButton.classList.add('selected');
      secondButton.classList.remove('selected');
    }
  }
  
    // Listen for messages
    window.addEventListener('message', function(event) {
        // If a 'load' command is received, load the song
        if (event.data.command === 'load') {
            fetch(event.data.path)
                .then(response => response.json())
                .then(song => loadSong(song));
        }
        // If a 'play' command is received, start the sequencer
        else if (event.data.command === 'play') {
            startScheduler();
        }
        // If a 'stop' command is received, stop the sequencer
        else if (event.data.command === 'stop') {
            stopScheduler();
        }
        // If a 'pause' command is received, pause the sequencer
        else if (event.data.command === 'pause') {
            pauseScheduler();
        }
    });


</script>

    
    </body>
    </html>
    
