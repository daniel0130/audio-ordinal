<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generate Royalty Receipt</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .form-group input[readonly] {
            background-color: #f0f0f0;
        }
        button {
            padding: 10px 15px;
            margin-right: 10px;
        }
        button#generateIndividualReceipt {
            background-color: red;
            color: white;
            cursor: not-allowed;
        }
        button#generateIndividualReceipt[enabled="true"] {
            background-color: green;
            cursor: pointer;
        }
        #receipt {
            display: none;
            width: 600px;
            height: 600px;
            position: relative;
            border: 1px solid #000;
            padding: 20px;
            box-sizing: border-box;
            overflow: hidden;
            background: none; /* No default background */
        }
        #receipt::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: var(--bg-url);
            background-size: cover;
            background-position: center;
            opacity: 0.2;
            z-index: 1;
        }
        #receipt-content {
            position: relative;
            z-index: 2;
            color: black; /* Ensure text remains black */
        }
        #receipt img, #receipt iframe {
            position: absolute;
            top: 10px;
            right: 10px;
            max-width: 100px;
            max-height: 100px;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: black;
            color: #fff;
            text-align: center;
            border-radius: 5px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Generate Royalty Receipt</h1>
        <div class="form-group">
            <label for="songName">Song Name:</label>
            <input type="text" id="songName">
        </div>
        <div class="form-group">
            <label for="songUrl">Song URL:</label>
            <input type="text" id="songUrl">
        </div>
        <div class="form-group">
            <label for="ordinalElementId">Ordinal Element ID Used In Song:</label>
            <input type="text" id="ordinalElementId" oninput="checkOrdinalElementId()">
        </div>
        <div class="form-group">
            <label for="collectionArtworkUrl">Song Collection Artwork URL:</label>
            <input type="text" id="collectionArtworkUrl">
        </div>
        <div class="form-group">
            <label for="receiptBackgroundUrl">Receipt Background Artwork URL:</label>
            <input type="text" id="receiptBackgroundUrl">
        </div>
        <div class="form-group">
            <label for="totalCollectionSize">Total Collection Size:</label>
            <input type="number" id="totalCollectionSize" value="1000" oninput="calculate()">
        </div>
        <div class="form-group">
            <label for="pricePerItem">Price Per Item (BTC):</label>
            <input type="number" id="pricePerItem" value="0.00025" oninput="calculate()">
        </div>
        <div class="form-group">
            <label for="totalItemsSold">Total Items Sold:</label>
            <input type="number" id="totalItemsSold" value="1000" oninput="calculate()">
        </div>
        <div class="form-group">
            <label for="totalEarned">Total Earned (BTC):</label>
            <input type="number" id="totalEarned" value="0.045" oninput="calculate()">
        </div>
        <div class="form-group">
            <label for="marketplaceCut">Marketplace Cut (%):</label>
            <input type="number" id="marketplaceCut" value="10" oninput="calculate()">
        </div>
        <div class="form-group">
            <label for="numRecipients">Number of Royalty Recipients:</label>
            <input type="number" id="numRecipients" value="16" oninput="calculate()">
        </div>
        <div class="form-group">
            <label for="totalReceived">Total Received After Costs (BTC):</label>
            <input type="number" id="totalReceived" readonly>
        </div>
        <div class="form-group">
            <label for="totalRoyalties">Total Royalties Earned (BTC):</label>
            <input type="number" id="totalRoyalties" readonly>
        </div>
        <div class="form-group">
            <label for="royaltySplit">Each Royalty Split Receives (BTC):</label>
            <input type="number" id="royaltySplit" readonly>
        </div>
        <button onclick="generateDataFile()">Generate Data File</button>
        <button onclick="loadDataFile()">Load Data File</button>
        <div class="tooltip">
            <button id="generateIndividualReceipt" onclick="generateIndividualReceipt()" disabled>Generate Individual Receipt</button>
            <span class="tooltiptext">Must have a unique Ordinal ID before generating an individual receipt</span>
        </div>
        <div id="receipt">
            <img id="collectionArtwork" src="" alt="Collection Artwork">
            <iframe id="collectionArtworkIframe" src="" style="display:none;"></iframe>
            <div id="receipt-content"></div>
        </div>
    </div>
    <script>
      // Utility function for validation
      function isValidUrl(string) {
          try {
              new URL(string);
              return true;
          } catch (_) {
              return false;
          }
      }
  
      function isValidOrdinalId(id) {
          const regex = /^[0-9a-fA-F]{64}(i\d+)?$/;
          return regex.test(id);
      }
  
      function extractIdFromUrl(url) {
          return url.split('/').pop();
      }
  
      function setupUrlListeners() {
          const urlFields = ['songUrl', 'ordinalElementId', 'collectionArtworkUrl', 'receiptBackgroundUrl'];
          urlFields.forEach(fieldId => {
              const field = document.getElementById(fieldId);
              field.addEventListener('input', function() {
                  if (isValidUrl(this.value)) {
                      this.value = extractIdFromUrl(this.value);
                  }
                  if (fieldId === 'ordinalElementId') {
                      checkOrdinalElementId();
                  }
              });
          });
      }
  
      function calculate() {
          const totalCollectionSize = parseInt(document.getElementById('totalCollectionSize').value) || 0;
          const pricePerItem = parseFloat(document.getElementById('pricePerItem').value) || 0;
          const totalItemsSold = parseInt(document.getElementById('totalItemsSold').value) || 0;
          const totalEarned = totalItemsSold * pricePerItem;
          const marketplaceCut = parseFloat(document.getElementById('marketplaceCut').value) || 0;
          const totalReceived = totalEarned - (totalEarned * marketplaceCut / 100);
          const numRecipients = parseInt(document.getElementById('numRecipients').value) || 0;
          const totalRoyalties = totalReceived * 0.2;
          const royaltySplit = numRecipients > 0 ? totalRoyalties / numRecipients : 0;
  
          document.getElementById('totalEarned').value = totalEarned.toFixed(8);
          document.getElementById('totalReceived').value = totalReceived.toFixed(8);
          document.getElementById('totalRoyalties').value = totalRoyalties.toFixed(8);
          document.getElementById('royaltySplit').value = royaltySplit.toFixed(8);
      }
  
      function generateDataFile() {
          const fields = ['songName', 'songUrl', 'totalCollectionSize', 'pricePerItem', 'marketplaceCut', 'totalReceived', 'numRecipients', 'totalRoyalties', 'royaltySplit', 'collectionArtworkUrl', 'receiptBackgroundUrl', 'ordinalElementId'];
          const receiptData = fields.reduce((data, field) => {
              const value = document.getElementById(field).value;
              if (field.includes('Url') && !isValidOrdinalId(value)) {
                  alert(`${field.replace(/([A-Z])/g, ' $1')} is not a valid URL.`);
                  return data;
              }
              if (field === 'ordinalElementId' && !isValidOrdinalId(value)) {
                  alert('Ordinal Element ID is not valid.');
                  return data;
              }
              data[field] = value;
              return data;
          }, {});
  
          const blob = new Blob([JSON.stringify(receiptData)], { type: 'application/json' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'receiptData.json';
          link.click();
      }
  
      function loadDataFile() {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = 'application/json';
          input.onchange = event => {
              const file = event.target.files[0];
              const reader = new FileReader();
              reader.onload = () => {
                  const receiptData = JSON.parse(reader.result);
                  for (const key in receiptData) {
                      if (receiptData.hasOwnProperty(key)) {
                          document.getElementById(key).value = receiptData[key];
                      }
                  }
                  checkOrdinalElementId();
                  calculate();
              };
              reader.readAsText(file);
          };
          input.click();
      }
  
      function generateIndividualReceipt() {
          const ordinalElementId = document.getElementById('ordinalElementId').value;
          if (!ordinalElementId) {
              alert('Ordinal Element ID is required to generate an individual receipt.');
              return;
          }
          if (!isValidOrdinalId(ordinalElementId)) {
              alert('Ordinal Element ID is not valid.');
              return;
          }
  
          const fields = ['songName', 'songUrl', 'totalEarned', 'marketplaceCut', 'totalReceived', 'numRecipients', 'totalRoyalties', 'royaltySplit', 'collectionArtworkUrl', 'receiptBackgroundUrl'];
          const receiptData = fields.reduce((data, field) => {
              const value = document.getElementById(field).value;
              if (field.includes('Url') && !isValidOrdinalId(value)) {
                  alert(`${field.replace(/([A-Z])/g, ' $1')} is not a valid URL.`);
                  return data;
              }
              data[field] = value;
              return data;
          }, {});
          receiptData.ordinalElementId = ordinalElementId;
  
          const receiptContent = `
            <h2>Audional Royalty Payment</h2>
            ${Object.keys(receiptData).map(key => {
                if (key === 'ordinalElementId' || key === 'songUrl') {
                    return `<p><strong>${key.replace(/([A-Z])/g, ' $1')}:</strong> <a href="https://ordinals.com/content/${receiptData[key]}" target="_blank">${receiptData[key]}</a></p>`;
                }
                if (key !== 'collectionArtworkUrl' && key !== 'receiptBackgroundUrl') {
                    return `<p><strong>${key.replace(/([A-Z])/g, ' $1')}:</strong> ${receiptData[key]}</p>`;
                }
                return '';
            }).join('')}
            <div style="margin-top: 10px; padding: 5px; border: 2px solid red; text-align: center;">
                <strong>***IMPORTANT - PLEASE READ***</strong>
            <p>
                This ordinal inscription facilitates automated and decentralized royalty payments between artists, sample holders, and plug-in creators. Payments are embedded in the padding of royalty receipts, using ordinal IDs, without needing payment addresses.
                If you are the original reciever of this royalty receipt, it may contain royalty payments.
            </p>
        </div>
        `;
  
          document.getElementById('receipt-content').innerHTML = receiptContent;
  
          const collectionArtworkUrl = `https://ordinals.com/content/${receiptData.collectionArtworkUrl}`;
          if (collectionArtworkUrl && collectionArtworkUrl.endsWith('.html')) {
              document.getElementById('collectionArtworkIframe').src = collectionArtworkUrl;
              document.getElementById('collectionArtworkIframe').style.display = 'block';
              document.getElementById('collectionArtwork').style.display = 'none';
          } else {
              document.getElementById('collectionArtwork').src = collectionArtworkUrl;
              document.getElementById('collectionArtwork').style.display = 'block';
              document.getElementById('collectionArtworkIframe').style.display = 'none';
          }
  
          const receiptBackgroundUrl = `https://ordinals.com/content/${receiptData.receiptBackgroundUrl}`;
          if (receiptBackgroundUrl) {
              const receipt = document.getElementById('receipt');
              receipt.style.setProperty('--bg-url', `url(${receiptBackgroundUrl})`);
              receipt.style.display = 'block';
          }
      }
  
      function checkOrdinalElementId() {
          const ordinalElementId = document.getElementById('ordinalElementId').value;
          const button = document.getElementById('generateIndividualReceipt');
          const isValid = isValidOrdinalId(ordinalElementId);
          button.disabled = !isValid;
          button.style.backgroundColor = isValid ? 'green' : 'red';
          button.style.cursor = isValid ? 'pointer' : 'not-allowed';
          button.setAttribute('enabled', isValid ? 'true' : 'false');
      }
  
      window.onload = function() {
          calculate();
          setupUrlListeners();
          checkOrdinalElementId();
      };
  </script>
  
</body>
</html>
