<!DOCTYPE html>

<style>@keyframes flash{0%{background-color:var(--primary-color)}50%{background-color:#0f0}100%{background-color:var(--primary-color)}}@keyframes flashingYellow{0%{background-color:#999902}50%{background-color:#ff0}100%{background-color:#999902}}.clear-button.flashing{animation:flashingYellow .5s infinite}.channel{display:flex}.ordinal-loaded{border:2px solid #f7931a}#play,#stop{flex:1;width:50px;height:50px}.clear-button,.mute-button,.solo-button{flex:1;min-width:18px;max-width:18px}.letter{z-index:1;font-size:16px;position:relative;left:-5px;top:-3px;color:#000}#play{animation:flash 2s infinite ease-in-out}#play.selected,#stop.selected~#play{animation:none}#stop.selected~#play,.mute-button.selected,.solo-button.selected{background-color:var(--accent-color)}#play.selected .letter,#stop.selected~#play .letter,.mute-button.selected .letter,.solo-button.selected .letter,.step-button.selected .letter{color:#fff}.clear-button,.mute-button,.solo-button{aspect-ratio:1/1}.clear-button{background-color:#999902}.mute-button{background-color:#800}.solo-button{background-color:#b16921}.solo-button.selected{background-color:#ff8000}.step-button{position:relative;min-width:0;aspect-ratio:1/1;background-color:#555;color:#fff;max-width:20px;max-height:20px}.color-FF0000 .step-button.selected{background-color:red}.color-00FF00 .step-button.selected{background-color:#0F0}.color-0000FF .step-button.selected{background-color:#00F}.color-FFFF00 .step-button.selected{background-color:#FF0}.color-00FFFF .step-button.selected{background-color:#0FF}.color-FF00FF .step-button.selected{background-color:#F0F}.color-808080 .step-button.selected{background-color:grey}.color-FFFFFF .step-button.selected{background-color:#FFF}.color-FFA500 .step-button.selected{background-color:orange}.color-800080 .step-button.selected{background-color:purple}.color-008080 .step-button.selected{background-color:teal}.color-000080 .step-button.selected{background-color:navy}.color-800000 .step-button.selected{background-color:maroon}.color-008000 .step-button.selected{background-color:green}.color-FFC0CB .step-button.selected{background-color:pink}.color-D2691E .step-button.selected{background-color:#D2691E}.step-button:nth-child(4n+1):not(:nth-child(16n+1)){background-color:#add8e6}.step-button:nth-child(16n+1){background-color:#ff0}.step-button.selected,.step-button.selected:nth-child(16n+1),.step-button.selected:nth-child(4n+1):not(:nth-child(16n+1)){background-color:var(--accent-color)}.step-button.selected{background-color:var(--accent-color)}.step-button.playing{box-shadow:0 0 10px #969696 inset}.step-button.playing.selected{box-shadow:0 0 10px #960101 inset}.step-button.dimmed{opacity:.5}.load-sample-button{flex:1;overflow:auto;text-overflow:ellipsis;font-size:.8em;height:20px;max-width:15%;min-width:10%;padding:1px;font-weight:700}.load-sample-button:hover::after{position:absolute;top:100%;left:0;background:var(--primary-color);color:var(--main-bg-color);z-index:1}.color-FF0000 .color-FF0000 .step-button.selected{background-color:red}.color-00FF00 .color-FF0000 .step-button.selected{background-color:#0F0}.color-0000FF .color-FF0000 .step-button.selected{background-color:#00F}.color-FFFF00 .color-FF0000 .step-button.selected{background-color:#FF0}.color-00FFFF .color-FF0000 .step-button.selected{background-color:#0FF}.color-FF00FF .color-FF0000 .step-button.selected{background-color:#F0F}.color-808080 .color-FF0000 .step-button.selected{background-color:grey}.color-FFFFFF .color-FF0000 .step-button.selected{background-color:#FFF}.color-FFA500 .color-FF0000 .step-button.selected{background-color:orange}.color-800080 .color-FF0000 .step-button.selected{background-color:purple}.color-008080 .color-FF0000 .step-button.selected{background-color:teal}.color-000080 .color-FF0000 .step-button.selected{background-color:navy}.color-800000 .color-FF0000 .step-button.selected{background-color:maroon}.color-008000 .color-FF0000 .step-button.selected{background-color:green}.color-FFC0CB .color-FF0000 .step-button.selected{background-color:pink}.color-D2691E .color-FF0000 .step-button.selected{background-color:#D2691E}.button,h1 .button{border:none;background-color:var(--primary-color);cursor:pointer;box-shadow:var(--box-shadow-style);color:var(--main-bg-color);font-size:1em}.control-button{width:var(--control-button-dimension);height:var(--control-button-dimension);display:flex;align-items:center;justify-content:center;font-weight:700;margin:0;position:relative}.play-button,.stop-button{position:relative;width:30px;height:30px;font-size:14px;padding:5px}#play.selected{background-color:#0f0}.stop-button{background-color:var(--accent-color)}.button-label.stop{color:red}div[idModalContent] div{display:flex;align-items:center;justify-content:flex-start;margin-bottom:10px;cursor:pointer}div[idModalContent] div button{margin-right:10px;background-color:#f0f0f0;border:none;border-radius:50%;width:30px;height:30px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background-color .3s ease}div[idModalContent] div button:hover{background-color:#ddd}div[idModalContent] div a{text-decoration:none;display:flex;color:#000;transition:color .3s ease}div[idModalContent] div a:hover{color:#666}.dropdown:hover .dropbtn{background-color:#3e8e41}.action-button{border:none;color:#fff;text-align:center;text-decoration:none;display:inline-block;font-size:16px;cursor:pointer;border-radius:4px;transition:background-color .3s}.action-button:hover{background-color:#45a049}.tooltip{position:relative;display:inline-block;cursor:pointer}.tooltip .tooltiptext{visibility:hidden;max-width:150px;background-color:#333;color:#fff;text-align:center;border-radius:8px;position:absolute;z-index:1;bottom:calc(100% + 5px);left:50%;transform:translateX(-50%);opacity:.7;transition:opacity .3s;font-size:12px;pointer-events:none}.tooltip:hover .tooltiptext{visibility:visible;opacity:.7}.mode-switcher{display:flex;align-items:center;justify-content:center;margin-left:50px}.mode-switcher label{margin-right:10px}.mode-switcher input[type=checkbox]{appearance:none;width:40px;height:20px;background-color:#ccc;border-radius:10px;position:relative;cursor:pointer}.mode-switcher input[type=checkbox]:checked{background-color:#2196f3}.mode-switcher input[type=checkbox]::before{content:"";position:absolute;top:1px;left:1px;width:18px;height:18px;background-color:#fff;border-radius:50%;transition:transform .2s ease}.mode-switcher input[type=checkbox]:checked::before{transform:translateX(20px)}.custom-context-menu{position:absolute;background-color:#f9f9f9;border:1px solid #ccc;padding:5px;z-index:1000}body{background-color:var(--main-bg-color);color:var(--primary-color);font:normal normal normal 100%/1 var(--default-font)}#drum-machine{max-width:100%;margin:0 auto;padding:0;background-color:var(--secondary-bg-color);box-sizing:border-box}h1{text-align:center;display:flex;justify-content:space-between;align-items:center;position:relative}h3 .subtext{font-size:.8em;opacity:.7}h3:hover .subtext{font-size:1em;opacity:.5}.title{font-size:40px}.small-text,.smaller-text{font-size:20px}.larger-text{font-size:1.5em}.centered,.centered-text{display:block;text-align:center}.bright-orange{color:#f7931a}.drum-machine-container{width:95%;margin:0 auto;padding:20px}.steps-container{display:none}.drum-machine-container .steps-container{display:grid;grid-template-columns:repeat(64,minmax(10px,1fr));gap:0;overflow-x:auto}@media screen and (max-width:1280px){.drum-machine-container .steps-container{grid-template-columns:repeat(32,minmax(10px,1fr))}}@media screen and (max-width:1024px){.drum-machine-container .steps-container{grid-template-columns:repeat(16,minmax(10px,1fr))}}@media screen and (max-width:768px){.drum-machine-container .steps-container{grid-template-columns:repeat(16,minmax(10px,1fr))}}.controls-container{flex:1}.controls-container{margin:5px;border:1px solid #ccc;border-radius:5px;overflow:auto}*,::after,::before{box-sizing:border-box}.steps-container{display:none;grid-template-columns:repeat(64,minmax(10px,1fr));gap:0;overflow-x:auto}@media screen and (max-width:1280px){.steps-container{grid-template-columns:repeat(32,minmax(10px,1fr))}}@media screen and (max-width:1024px){.steps-container{grid-template-columns:repeat(16,minmax(10px,1fr))}}@media screen and (max-width:768px){.steps-container{grid-template-columns:repeat(16,minmax(10px,1fr))}}.channel-controls{margin-top:0}#sequence-lights{display:flex;flex-direction:row;justify-content:space-between;width:90%;margin-left:10%}.sequence-light{grid-column:span 1;height:15px;background-color:grey}.sequence-light.on{background-color:#adff2f}.quickplay-button-container{width:90%;margin:0 auto;display:flex;align-items:center;justify-content:center}.quick-play-button{width:30px;height:30px;padding:5px;margin:0 5px;display:flex;justify-content:center;align-items:center;background-color:#4CAF50;color:#fff;cursor:pointer}@media (max-width:600px){.quick-play-button{width:30px;height:30px;padding:3px}}.quick-play-button strong{display:block;font-weight:700}.quick-play-button.active{background-color:#32cd32}#next-sequence,#prev-sequence,button[for=mode-switcher]{font-size:12.5px;padding:5px 10px;font-weight:700}.loadSampleModalButton{position:fixed;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);display:flex;justify-content:center;align-items:center;z-index:9999}.loadSampleModalButton-content{background-color:#fff;padding:20px;border-radius:10px;width:50%;max-height:500px;overflow-y:auto}.loadSampleModalButton-text{color:#000;margin-bottom:10px}.loadSampleModalButton-input{margin-bottom:10px;width:100%;box-sizing:border-box}.loadSampleModalButton button{margin-top:10px;padding:10px 15px;border:none;border-radius:5px;color:#fff;cursor:pointer}.loadSampleModalButton button:hover{background-color:#f6ff00;color:#000}.channel-naming-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background-color:#fff;padding:20px;border-radius:10px;z-index:1000}.channel-name-input{width:100%;margin-bottom:10px}.loadSampleModalButton-link{padding:10px;margin-top:10px;color:#fff;background-color:#b0f;border:none;border-radius:5px;cursor:pointer}.loadSampleModalButton-link:hover{background-color:#b0f}.loadButton{background-color:#28a745}.cancelButton{background-color:#dc3545}.searchButton{background-color:#b0f}.tooltip{position:relative;display:inline-block}.tooltip .tooltiptext{visibility:hidden;width:120px;background-color:#000;color:#fff;text-align:center;border-radius:6px;padding:5px 0;position:absolute;z-index:1;bottom:125%;left:100%;margin-left:-60px;opacity:0;transition:opacity .3s}.tooltip .tooltiptext::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:#000 transparent transparent transparent}.tooltip:hover .tooltiptext{visibility:visible;opacity:1}.load-popup{display:none;position:absolute;bottom:30px;right:0;border:1px solid #aaa;background-color:#f9f9f9;z-index:1000}.load-popup button{display:block;padding:10px;border:none;width:50%;text-align:left;cursor:pointer;background-color:#f9f9f9}.load-popup button:hover{background-color:#ddd}.modal{display:none;position:fixed;z-index:1;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:#000;background-color:rgba(0,0,0,.4)}.modal-content{background-color:#fefefe;margin:15% auto;padding:20px;border:1px solid #888;width:80%}.close-button{color:#aaa;float:right;font-size:28px;font-weight:700}.close-button:focus,.close-button:hover{color:#000;text-decoration:none;cursor:pointer}#new-load-button,#save-button{margin-left:2px;right:0}#new-load-button{margin-left:2px;right:0;background-color:#fff;color:#000;animation:smooth-wave 4s linear infinite}@keyframes smooth-wave{0%{background-color:#fff;color:#000}25%{background-color:#fd6f6f;color:#000}50%{background-color:#fff;color:#000}75%{background-color:#ff6f6f;color:#000}100%{background-color:#fff;color:#000}}.copy-button{background-color:#2196F3}.copy-button:hover{background-color:#0b7dda}.paste-button{background-color:#FFC107}.paste-button:hover{background-color:#ffb300}:root{--scale-factor:1vw;--main-bg-color:#000;--secondary-bg-color:#333;--primary-color:#fff;--accent-color:#f00;--button-dimension:5vw;--control-button-dimension:18px;--box-shadow-style:0 0 1vw var(--main-bg-color)inset;--default-font:Arial,sans-serif}.channel{width:100%}</style><meta content="width=device-width,initial-scale=1"name=viewport><div class=drum-machine-container><div id=drum-machine><h1><span class=button-label>Play</span><div class="tooltip button button-round"><div class="button play-button"id=play></div><span class=tooltiptext>Start the sequence.</span></div><span class="button-label stop">Stop</span><div class="tooltip button button-round"><div class="button stop-button"id=stop></div><span class=tooltiptext>Stop the sequence.</span></div><div class="tooltip bpm-container">BPM: <input id=bpm-slider type=range max=180 min=60 step=1 title="Adjust the Beats Per Minute"value=105><div class=bpm-display id=bpm-display>105</div><span class=tooltiptext>Drag to adjust the BPM (Beats Per Minute) of the sequence.</span></div><span class=title>Audional Sequencer<br><span class=bright-orange>₿</span>itcoin<span class=bright-orange>₿</span>eats<span class="bright-orange small-text,">₿</span><span class=small-text>eta</span></span></h1><div class=utility-buttons><button class=tooltip id=save-button>Save <span class=tooltiptext>This button will save your sequence into JSON file for download so you can recall it later on.</span></button> <input id=save-file-input type=file style=display:none> <button class=tooltip id=new-load-button>Load <span class=tooltiptext>This button will load your audional composition JSON files, even while the sequencer is playing live.</span></button><div class=load-popup id=loadOptions><button id=loadJson>Load from Json file</button></div><input id=load-file-input type=file style=display:none accept=.json> <button class="tooltip action-button copy-button"id=copy-sequence-settings>Copy <span class=tooltiptext>Copy Sequence Steps</span></button> <button class="tooltip action-button paste-button"id=paste-button>Paste <span class=tooltiptext>Paste the sequence settings from clipboard.</span></button><label class=tooltip for=project-name>Project Name <span class=tooltiptext>Enter the project name</span></label><input id=project-name class=project-name placeholder="Enter project name"></div><div class=subtext-container><p class="centered-text subtext">Raw On-chain <span class=bright-orange>₿</span>itcoin Audionals: playing live, directly from the <span>₿</span>lockchain!</div><main id=app role=main><div class=channel-template style=display:none><div class=channel><button class="tooltip load-sample-button"title="Load New Audional">Load New Audional <span class=tooltiptext>Use this button to load a new audional sample into the current channel.</span></button> <button class="tooltip control-button open-audio-trimmer"style=background-color:#00f;font-weight:700><span class=letter>T</span> <span class=tooltiptext>Open Audio Trimmer for this channel.</span></button> <button class="tooltip control-button clear-button"><span class=letter>C</span> <span class=tooltiptext>Clear the current channel's sequence.</span><div class=clear-confirm style=display:none;position:absolute;background-color:rgba(0,0,0,.7);color:#fff;padding:5px;border-radius:3px;z-index:10>Click again to confirm clear</div></button> <button class="tooltip control-button mute-button"><span class=letter>M</span> <span class=tooltiptext>Mute or unmute the current channel.</span></button> <button class="tooltip control-button solo-button"><span class=letter>S</span> <span class=tooltiptext>Solo the current channel.</span></button><div class=steps-container></div></div></div></div></div><div class=quickplay-button-container><button class=tooltip id=prev-sequence>Previous Sequence <span class=tooltiptext>Go to the previous sequence</span></button> <span class=tooltip id=current-sequence-display>Sequence 0 <span class=tooltiptext>Currently displayed sequence</span> </span><button class=tooltip id=next-sequence>Next Sequence <span class=tooltiptext>Go to the next sequence</span></button><label class=tooltip for=continuous-play>Continuous Play <span class=tooltiptext>Toggle continuous play mode</span></label><input id=continuous-play type=checkbox checked class=tooltip></div><div class=modal id=audio-trimmer-modal hidden><div class=modal-content><span class=close-button>×</span><div id=audio-trimmer-container></div></div></div>
<script>


const mainContainer = document.getElementById("app");
const channelTemplateContainer = document.querySelector(".channel-template");
const channelTemplate = channelTemplateContainer.querySelector(".channel");
const quickPlayButtons = [];
const quickPlayContainer = document.createElement("div");

quickPlayContainer.id = "quickplay-container";
quickPlayContainer.style.display = "flex";
quickPlayContainer.style.justifyContent = "center";
quickPlayContainer.style.marginBottom = "20px";

document.addEventListener("DOMContentLoaded", () => {
    for (let sequenceIndex = 0; sequenceIndex < 16; sequenceIndex++) {
        for (let channelIndex = 0; channelIndex < 16; channelIndex++) {
            let stepsContainer = document.querySelector(`#channel-${channelIndex}-steps-container`);
            if (!stepsContainer) {
                stepsContainer = document.createElement("div");
                stepsContainer.id = `channel-${channelIndex}-steps-container`;
                stepsContainer.classList.add("steps-container");
                document.body.appendChild(stepsContainer);
            }
            stepsContainer.innerHTML = "";

            for (let stepIndex = 0; stepIndex < 64; stepIndex++) {
                const stepButton = document.createElement("button");
                stepButton.classList.add("step-button");
                stepButton.id = `Sequence${sequenceIndex}-ch${channelIndex}-step-${stepIndex}`;
                stepButton.addEventListener("click", () => {
                    let currentState = window.unifiedSequencerSettings.getStepState(sequenceIndex, channelIndex, stepIndex);
                    console.log(`[updateSpecificStepUI] [getStepState applied] Step button clicked: Sequence ${sequenceIndex}, Channel ${channelIndex}, Step ${stepIndex}, Current State: ${currentState}`);
                    window.unifiedSequencerSettings.updateStepState(sequenceIndex, channelIndex, stepIndex, !currentState);
                    console.log(`[updateSpecificStepUI] Step button clicked: Sequence ${sequenceIndex}, Channel ${channelIndex}, Step ${stepIndex}, New State: ${!currentState}`);
                    updateSpecificStepUI(sequenceIndex, channelIndex, stepIndex);
                });
                stepsContainer.appendChild(stepButton);
            }
        }
    }
});

if (window.self !== window.top) { // Check if in an iframe
    let presetLoaded = false; // Flag to track if the preset file has been loaded

    // Add a global click listener that toggles playback
    window.addEventListener("click", async (event) => {
        event.stopPropagation(); // Prevent event propagation

        console.log("[playbackDebug] Overlay clicked. State of audioContext:", audioContext.state);

        if (!presetLoaded) {
            try {
                const response = await fetch('BasedSong1.json'); // Adjust the path as needed
                const json = await response.json();
                console.log("[Load Process] Settings loaded:", json);

                // Assuming window.unifiedSequencerSettings exists and is ready to use
                window.unifiedSequencerSettings.loadSettings(json);
                console.log("[Load Process] Settings applied to the sequencer");

                // Process channel URLs for audio loading
                if (json.channelURLs && Array.isArray(json.channelURLs)) {
                    await processChannelURLs(json.channelURLs);
                }

                presetLoaded = true; // Mark the preset as loaded

            } catch (error) {
                console.error("[Load Process] Error loading or applying settings:", error);
            }
        }

        if (!audioContext) {
            try {
                // Create new audio context
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log("[AudioContext] AudioContext created.");
            } catch (error) {
                console.error("[AudioContext] Error creating AudioContext:", error);
            }
        }

        if (audioContext && audioContext.state === 'suspended') {
            await audioContext.resume();
            console.log("[AudioContext] AudioContext resumed.");
        }

        if (isPlaying) {
            stopScheduler();
            emitStop(); // Assume this function signals the stop event
            isPlaying = false;
            console.log("[Playback] Playback stopped.");
        } else {
            startScheduler();
            emitPlay(); // Assume this function signals the play event
            isPlaying = true;
            console.log("[Playback] Playback started.");
        }
    }, true); // Use capture phase to ensure the event is handled first
}

</script>> 
</body>
</html>